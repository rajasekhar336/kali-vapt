#!/usr/bin/env python3
"""
Rule-based vulnerability classifier for Qwen 0.5B
Bypasses AI timeout issues with pattern matching
"""

import re

def classify_vulnerability(tool_name, tool_output, target_domain):
    """Classify vulnerability using pattern matching rules"""
    
    # Normalize tool output for pattern matching
    output_lower = tool_output.lower()
    
    # CSP Violation patterns
    if any(pattern in output_lower for pattern in [
        'csp:', 'content security policy', 'script-src unsafe-inline',
        'unsafe-inline', 'csp violation', 'script-src'
    ]):
        return {
            "issue": "Content Security Policy Violation",
            "issue_type": "csp_violation",
            "severity": "medium",
            "url": f"https://{target_domain}",
            "description": "Content Security Policy allows unsafe inline scripts"
        }
    
    # Security Headers Missing patterns
    elif any(pattern in output_lower for pattern in [
        'missing x-frame-options', 'x-frame-options missing',
        'missing security headers', 'x-content-type-options',
        'strict-transport-security missing', 'hsts missing'
    ]):
        return {
            "issue": "Security Headers Missing",
            "issue_type": "security_headers_missing",
            "severity": "medium",
            "url": f"https://{target_domain}",
            "description": "Missing security headers increase attack surface"
        }
    
    # XSS patterns
    elif any(pattern in output_lower for pattern in [
        'cross site scripting', 'xss', 'reflected xss',
        'stored xss', 'dom xss', '<script>', 'onerror='
    ]):
        return {
            "issue": "Cross Site Scripting",
            "issue_type": "xss_reflected",
            "severity": "high",
            "url": f"https://{target_domain}",
            "description": "Cross Site Scripting vulnerability allows script injection"
        }
    
    # SQL Injection patterns
    elif any(pattern in output_lower for pattern in [
        'sql injection', 'sqlmap', 'parameterized', 'union select',
        'or 1=1', 'mysql', 'postgresql'
    ]):
        return {
            "issue": "SQL Injection",
            "issue_type": "sql_injection",
            "severity": "high",
            "url": f"https://{target_domain}",
            "description": "SQL injection allows database manipulation"
        }
    
    # Hidden File patterns
    elif any(pattern in output_lower for pattern in [
        '.git', '.env', '.svn', 'hidden file', 'backup file',
        'config file', 'database.yml', 'wp-config'
    ]):
        return {
            "issue": "Hidden File Exposure",
            "issue_type": "hidden_file",
            "severity": "medium",
            "url": f"https://{target_domain}",
            "description": "Sensitive configuration files exposed"
        }
    
    # Information Disclosure patterns
    elif any(pattern in output_lower for pattern in [
        'server:', 'apache/', 'nginx/', 'php version',
        'information disclosure', 'version leak', 'banner'
    ]):
        return {
            "issue": "Information Disclosure",
            "issue_type": "information_disclosure",
            "severity": "low",
            "url": f"https://{target_domain}",
            "description": "Server information disclosure aids attackers"
        }
    
    # Default fallback
    else:
        return {
            "issue": "Security Finding",
            "issue_type": "other",
            "severity": "medium",
            "url": f"https://{target_domain}",
            "description": f"Security issue detected by {tool_name}"
        }

def test_classifier():
    """Test the classifier with sample inputs"""
    
    test_cases = [
        ("zap", "WARN-NEW: CSP: script-src unsafe-inline [10055] https://example.com/v2/", "example.com"),
        ("nuclei", "[cve] CVE-2021-44228: Log4j RCE detected", "example.com"),
        ("zap", "Missing X-Frame-Options header", "example.com"),
        ("sqlmap", "Parameter 'id' is vulnerable to SQL injection", "example.com"),
        ("nmap", "PORT   STATE SERVICE\n80/tcp open  http    Apache httpd 2.4.29", "example.com")
    ]
    
    for tool, output, target in test_cases:
        result = classify_vulnerability(tool, output, target)
        print(f"Tool: {tool}")
        print(f"Input: {output[:50]}...")
        print(f"Result: {result['issue_type']} - {result['issue']}")
        print("---")

if __name__ == "__main__":
    test_classifier()

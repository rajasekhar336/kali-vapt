'use client'

import * as React from 'react'
import { useState } from 'react'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Progress } from '@/components/ui/progress'
import { 
  Shield, 
  AlertTriangle, 
  CheckCircle2, 
  Clock, 
  Download, 
  Eye, 
  Copy, 
  ExternalLink,
  Zap,
  Target,
  Lock,
  FileText,
  TrendingUp,
  Activity,
  Calendar,
  User,
  BarChart3
} from 'lucide-react'

interface Vulnerability {
  id: string
  title: string
  severity: 'critical' | 'high' | 'medium' | 'low' | 'info'
  tool: string
  endpoint: string
  description: string
  cvss_score?: number
  cve_id?: string
  discovered_at: string
  status: 'open' | 'in_progress' | 'resolved'
  has_remediation: boolean
  remediation?: {
    steps: string[]
    priority: 'high' | 'medium' | 'low'
    estimated_time: string
    code_example?: string
  }
}

interface Scan {
  id: string
  target_domain: string
  scan_type: string
  status: 'running' | 'completed' | 'failed' | 'pending'
  started_at: string
  completed_at?: string
  vulnerabilities_count: number
  critical_count: number
  high_count: number
  medium_count: number
  low_count: string
  progress?: number
}

interface VulnerabilityDetailsProps {
  vulnerability: Vulnerability
  onRequestRemediation: (vulnId: string) => void
  onExportReport: (vulnId: string) => void
}

export default function VulnerabilityDetails({ 
  vulnerability, 
  onRequestRemediation, 
  onExportReport 
}: VulnerabilityDetailsProps) {
  const [showRemediation, setShowRemediation] = useState(false)
  const [copiedCode, setCopiedCode] = useState(false)

  const getSeverityColor = (severity: string) => {
    switch (severity) {
      case 'critical': return 'destructive'
      case 'high': return 'destructive'
      case 'medium': return 'warning'
      case 'low': return 'secondary'
      default: return 'outline'
    }
  }

  const getSeverityIcon = (severity: string) => {
    switch (severity) {
      case 'critical': return <AlertTriangle className="h-4 w-4" />
      case 'high': return <AlertTriangle className="h-4 w-4" />
      case 'medium': return <AlertTriangle className="h-4 w-4" />
      case 'low': return <Shield className="h-4 w-4" />
      default: return <Eye className="h-4 w-4" />
    }
  }

  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'open': return <AlertTriangle className="h-4 w-4 text-red-600" />
      case 'in_progress': return <Clock className="h-4 w-4 text-yellow-600" />
      case 'resolved': return <CheckCircle2 className="h-4 w-4 text-green-600" />
      default: return <Clock className="h-4 w-4" />
    }
  }

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text)
    setCopiedCode(true)
    setTimeout(() => setCopiedCode(false), 2000)
  }

  return (
    <div className="max-w-6xl mx-auto p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold text-slate-900 flex items-center gap-3">
            {getSeverityIcon(vulnerability.severity)}
            {vulnerability.title}
          </h1>
          <div className="flex items-center gap-4 mt-2">
            <Badge variant={getSeverityColor(vulnerability.severity)} className="text-sm">
              {vulnerability.severity.toUpperCase()}
            </Badge>
            {vulnerability.cvss_score && (
              <Badge variant="outline" className="text-sm">
                CVSS: {vulnerability.cvss_score}
              </Badge>
            )}
            {vulnerability.cve_id && (
              <Badge variant="outline" className="text-sm">
                {vulnerability.cve_id}
              </Badge>
            )}
            <div className="flex items-center gap-1 text-sm text-slate-600">
              {getStatusIcon(vulnerability.status)}
              <span>{vulnerability.status.replace('_', ' ')}</span>
            </div>
          </div>
        </div>
        <div className="flex gap-2">
          <Button variant="outline" onClick={() => onExportReport(vulnerability.id)}>
            <Download className="h-4 w-4 mr-2" />
            Export Report
          </Button>
          {!vulnerability.has_remediation && (
            <Button onClick={() => onRequestRemediation(vulnerability.id)}>
              <Zap className="h-4 w-4 mr-2" />
              Get AI Remediation
            </Button>
          )}
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Main Content */}
        <div className="lg:col-span-2 space-y-6">
          {/* Vulnerability Details */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <AlertTriangle className="h-5 w-5" />
                Vulnerability Details
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div>
                <h4 className="font-medium mb-2">Description</h4>
                <p className="text-slate-600">{vulnerability.description}</p>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <h4 className="font-medium mb-2">Detection Tool</h4>
                  <div className="flex items-center gap-2">
                    <Target className="h-4 w-4 text-blue-600" />
                    <span>{vulnerability.tool}</span>
                  </div>
                </div>
                <div>
                  <h4 className="font-medium mb-2">Affected Endpoint</h4>
                  <div className="flex items-center gap-2">
                    <ExternalLink className="h-4 w-4 text-green-600" />
                    <span className="font-mono text-sm">{vulnerability.endpoint}</span>
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <h4 className="font-medium mb-2">Discovered</h4>
                  <div className="flex items-center gap-2">
                    <Calendar className="h-4 w-4 text-slate-600" />
                    <span>{new Date(vulnerability.discovered_at).toLocaleString()}</span>
                  </div>
                </div>
                <div>
                  <h4 className="font-medium mb-2">Risk Level</h4>
                  <div className="flex items-center gap-2">
                    <BarChart3 className="h-4 w-4 text-slate-600" />
                    <Badge variant={getSeverityColor(vulnerability.severity)}>
                      {vulnerability.severity.toUpperCase()}
                    </Badge>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* AI Remediation */}
          {vulnerability.has_remediation && vulnerability.remediation && (
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Zap className="h-5 w-5 text-purple-600" />
                  AI-Powered Remediation
                </CardTitle>
                <CardDescription>
                  Automated remediation steps generated by our AI security engine
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="flex items-center gap-4">
                  <div>
                    <h4 className="font-medium">Priority</h4>
                    <Badge variant={vulnerability.remediation.priority === 'high' ? 'destructive' : 
                                   vulnerability.remediation.priority === 'medium' ? 'warning' : 'secondary'}>
                      {vulnerability.remediation.priority.toUpperCase()}
                    </Badge>
                  </div>
                  <div>
                    <h4 className="font-medium">Estimated Time</h4>
                    <span className="text-slate-600">{vulnerability.remediation.estimated_time}</span>
                  </div>
                </div>

                <div>
                  <h4 className="font-medium mb-3">Remediation Steps</h4>
                  <div className="space-y-2">
                    {vulnerability.remediation.steps.map((step, index) => (
                      <div key={index} className="flex gap-3 p-3 bg-slate-50 rounded-lg">
                        <div className="flex-shrink-0 w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-medium">
                          {index + 1}
                        </div>
                        <p className="text-slate-700">{step}</p>
                      </div>
                    ))}
                  </div>
                </div>

                {vulnerability.remediation.code_example && (
                  <div>
                    <div className="flex items-center justify-between mb-2">
                      <h4 className="font-medium">Code Example</h4>
                      <Button 
                        size="sm" 
                        variant="outline"
                        onClick={() => copyToClipboard(vulnerability.remediation!.code_example!)}
                      >
                        {copiedCode ? 'Copied!' : <Copy className="h-4 w-4" />}
                      </Button>
                    </div>
                    <pre className="bg-slate-900 text-slate-100 p-4 rounded-lg overflow-x-auto">
                      <code>{vulnerability.remediation.code_example}</code>
                    </pre>
                  </div>
                )}
              </CardContent>
            </Card>
          )}
        </div>

        {/* Sidebar */}
        <div className="space-y-6">
          {/* Quick Actions */}
          <Card>
            <CardHeader>
              <CardTitle className="text-lg">Quick Actions</CardTitle>
            </CardHeader>
            <CardContent className="space-y-3">
              <Button className="w-full" variant="outline">
                <Eye className="h-4 w-4 mr-2" />
                View in Scanner
              </Button>
              <Button className="w-full" variant="outline">
                <FileText className="h-4 w-4 mr-2" />
                Generate Report
              </Button>
              <Button className="w-full" variant="outline">
                <ExternalLink className="h-4 w-4 mr-2" />
                Open Endpoint
              </Button>
            </CardContent>
          </Card>

          {/* Related Vulnerabilities */}
          <Card>
            <CardHeader>
              <CardTitle className="text-lg">Related Issues</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-3">
                <div className="p-3 bg-slate-50 rounded-lg">
                  <div className="flex items-center gap-2 mb-1">
                    <Badge variant="warning" className="text-xs">MEDIUM</Badge>
                    <span className="text-sm font-medium">XSS Vulnerability</span>
                  </div>
                  <p className="text-xs text-slate-600">Same endpoint: {vulnerability.endpoint}</p>
                </div>
                <div className="p-3 bg-slate-50 rounded-lg">
                  <div className="flex items-center gap-2 mb-1">
                    <Badge variant="secondary" className="text-xs">LOW</Badge>
                    <span className="text-sm font-medium">Missing Security Headers</span>
                  </div>
                  <p className="text-xs text-slate-600">Same tool: {vulnerability.tool}</p>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Risk Assessment */}
          <Card>
            <CardHeader>
              <CardTitle className="text-lg">Risk Assessment</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div>
                <div className="flex justify-between mb-1">
                  <span className="text-sm font-medium">Exploitability</span>
                  <span className="text-sm text-red-600">High</span>
                </div>
                <Progress value={85} className="h-2" />
              </div>
              <div>
                <div className="flex justify-between mb-1">
                  <span className="text-sm font-medium">Impact</span>
                  <span className="text-sm text-red-600">Critical</span>
                </div>
                <Progress value={95} className="h-2" />
              </div>
              <div>
                <div className="flex justify-between mb-1">
                  <span className="text-sm font-medium">Overall Risk</span>
                  <span className="text-sm font-bold text-red-600">Critical</span>
                </div>
                <Progress value={90} className="h-2" />
              </div>
            </CardContent>
          </Card>
        </div>
      </div>
    </div>
  )
}

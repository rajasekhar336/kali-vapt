version: '3.8'

services:
  # PostgreSQL Database
  vapt-db:
    image: postgres:15
    container_name: vapt-db
    environment:
      POSTGRES_DB: vapt_platform
      POSTGRES_USER: vapt_user
      POSTGRES_PASSWORD: vapt_secure_password
    volumes:
      - vapt_db_data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    networks:
      - vapt-network

  # Redis Cache
  vapt-redis:
    image: redis:7-alpine
    container_name: vapt-redis
    ports:
      - "6379:6379"
    networks:
      - vapt-network

  # Backend API Service
  vapt-backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: vapt-backend
    environment:
      DATABASE_URL: postgresql://vapt_user:vapt_secure_password@vapt-db:5432/vapt_platform
      REDIS_URL: redis://vapt-redis:6379
      AI_SERVICE_URL: http://172.20.0.1:8080
      DETECTDOJO_URL: http://172.20.0.1:8081
      DOCKER_SOCKET: /var/run/docker.sock
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/log/output:/var/log/output
      - /var/production:/var/production
    ports:
      - "8000:8000"
    depends_on:
      - vapt-db
      - vapt-redis
    networks:
      - vapt-network

  # Frontend Web UI
  vapt-frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: vapt-frontend
    environment:
      REACT_APP_API_URL: http://localhost:8000
    ports:
      - "80:3000"
    depends_on:
      - vapt-backend
    networks:
      - vapt-network

  # Celery Worker for background tasks
  vapt-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: vapt-worker
    command: celery -A app.celery worker --loglevel=info
    environment:
      DATABASE_URL: postgresql://vapt_user:vapt_secure_password@vapt-db:5432/vapt_platform
      REDIS_URL: redis://vapt-redis:6379
      AI_SERVICE_URL: http://172.20.0.1:8080
      DETECTDOJO_URL: http://172.20.0.1:8081
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/log/output:/var/log/output
      - /var/production:/var/production
    depends_on:
      - vapt-db
      - vapt-redis
    networks:
      - vapt-network

  # Existing AI Service (connect to existing)


volumes:
  vapt_db_data:

networks:
  vapt-network:
    driver: bridge
